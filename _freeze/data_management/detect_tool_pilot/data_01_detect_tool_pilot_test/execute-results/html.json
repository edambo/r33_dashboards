{
  "hash": "549f226d18de8603a7f8c9d4ca450596",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Clean DETECT tool pilot study data imported from REDCap\"\n---\n\n\n# Overview\n\nIn this file, we do some initial cleaning of the DETECT tool pilot study data imported from REDCap to prepare it for dashboard summary. This pilot lasted for 2 weeks, starting on 11/11/2024 and ending on 11/25/2023.\n\n\n# Load packages\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(dplyr, warn.conflicts = FALSE)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'dplyr' was built under R version 4.3.3\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(readr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'readr' was built under R version 4.3.2\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(purrr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'purrr' was built under R version 4.3.2\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(stringr)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'stringr' was built under R version 4.3.2\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(janitor)\nlibrary(here)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'here' was built under R version 4.3.3\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(readxl)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'readxl' was built under R version 4.3.2\n```\n\n\n:::\n\n```{.r .cell-code}\nlibrary(lubridate)\n```\n\n::: {.cell-output .cell-output-stderr}\n\n```\nWarning: package 'lubridate' was built under R version 4.3.2\n```\n\n\n:::\n:::\n\n\n\n# Load custom functions\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsource(here::here(\"R\", \"recoding_factoring_relocating.R\"))\nsource(here::here(\"R\", \"nums_to_na.R\"))\nsource(here::here(\"R\", \"data_cleaning_tools.R\"))\n```\n:::\n\n\n\n# Load data\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Raw data with numerically coded values\ntool_pilot_raw <- read_csv(here::here(\"data\", \"detect_tool_pilot\", \n                                      \"detect_tool_pilot_test_raw.csv\"))\n\n# Data labels\ntool_pilot_labels <- read_csv(\n  here::here(\"data\", \"detect_tool_pilot\",\n             \"detect_tool_pilot_test_labels_raw.csv\"))\n\n# Link data\ndefinitions_link_hits <- readxl::read_xlsx(\n  here::here(\"data\", \"detect_tool_pilot\", \"link_data\", \n             \"hits_for_elder_abuse_definitions.xlsx\"), \n  col_names = c(\"date\", \"elder_abuse_definitions\"), skip = 1,\n  )\n\nal_link_hits <- readxl::read_xlsx(\n  here::here(\"data\", \"detect_tool_pilot\", \"link_data\", \n             \"hits_for_detect_al.xlsx\"), skip = 1,\n  col_names = c(\"date\", \"detect_al\")\n  )\n\nca_link_hits <- readxl::read_xlsx(\n  here::here(\"data\", \"detect_tool_pilot\", \"link_data\", \n             \"hits_for_detect_ca.xlsx\"), skip = 1,\n  col_names = c(\"date\", \"detect_ca\")\n  )\n\nmd_link_hits <- readxl::read_xlsx(\n  here::here(\"data\", \"detect_tool_pilot\", \"link_data\", \n             \"hits_for_detect_md.xlsx\"), skip = 1,\n  col_names = c(\"date\", \"detect_md\")\n  )\n\ntx_link_hits <- readxl::read_xlsx(\n  here::here(\"data\", \"detect_tool_pilot\", \"link_data\", \n             \"hits_for_detect_tx.xlsx\"), skip = 1, \n  col_names = c(\"date\", \"detect_tx\")\n  )\n```\n:::\n\n\n\n# Column name cleaning\n\nHere we will convert all variable names to snake case with double underscores \nreduced to single underscores so that everything is uniform.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntool_pilot_raw <- clean_names(tool_pilot_raw) %>% \n  rename(ri_refer_svcs = r_refer_svcs,\n         ri_clinician_id = ri_clinician_id_2)\n```\n:::\n\n\n\n# Create a dataframe with variable descriptions\n\nExtract the column names from the data and labels data frames to create a data frame of variable descriptions.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create list of shortened variable labels based on the descriptions/ original questions\nlabels <- c(\"Record ID\", \"Survey Identifier\", \"Survey Timestamp\", \n           \"Form start timestamp\", \"Form date\", \"Enter survey password\", \n           \"Password verification\", \"Password verification\", \"Patient MRN\", \n           \"Institution\", \"Institution\", \"Institution\", \"Baylor clinician name\", \n           \"Other Baylor clinician name\", \"Johns Hopkins clinician name\", \n           \"Other Johns Hopkins clinician name\", \"UCSF clinician name\",\n           \"Other UCSF clinician name\", \"UAB clinician name\", \n           \"Other UAB clinician name\", \"UTSW clinician name\", \n           \"Other UTSW clinician name\", \"LBJ clinician name\", \n           \"Other LBJ clinician name\", \"UTP clinician name\", \n           \"Other UTP clinician name\", \"Clinician ID\", \"Clinician name\", \n           \"Absence of necessities\", \"Environment health or safety concern\", \n           \"Environment not assessed reason\", \"Defensive\", \n           \"Caregiver not assessed reason\", \"Other reason caregiver not assessed\",\n           \"Chemically sedated\", \"Isolated\", \"Anxious\", \"Prohibited\", \"Unmet needs\", \n           \"Unexplained injuries\", \"Patient not assessed reason\", \n           \"Suspect EM\", \"Indicators observed but EM not suspected reason\", \n           \"Suspect EM reason\", \"Self-neglect suspected\", \n           \"Financial exploitation suspected\", \n           \"Emotional or psychological abuse suspected\", \n           \"Physical abuse suspected\", \"Sexual abuse suspected\", \n           \"Caregiver neglect suspected\", \"Abandonment suspected\", \n           \"Other mistreatment type suspected\", \n           \"Dont know/ Not sure of mistreatment type\", \n           \"Specific other mistreatment type suspected\", \n           \"Intend to report to APS\", \"No intention to report to APS reason\", \n           \"Other service referral\", \"Specify other service\", \n           \"Have helpful details\", \"Brief note\", \"Complete\"\n)\n\n# Combine the variable names, descriptions and labels into a dataframe\nvar_desc <- data.frame(variable = names(tool_pilot_raw),\n                       description = names(tool_pilot_labels),\n                       label = labels) %>%\n  mutate(id = row_number())\nvar_desc\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                         variable\n1                       record_id\n2        redcap_survey_identifier\n3  reporting_instrument_timestamp\n4              ri_timestamp_start\n5                         ri_date\n6                  password_entry\n7           password_verification\n8            password_incorrect_1\n9                  ri_patient_mrn\n10                 ri_institution\n11               ri_institution_2\n12               calc_institution\n13               ri_clinician_bcm\n14           ri_clinician_bcm_oth\n15                ri_clinician_jh\n16            ri_clinician_jh_oth\n17              ri_clinician_ucsf\n18          ri_clinician_ucsf_oth\n19               ri_clinician_uab\n20           ri_clinician_uab_oth\n21              ri_clinician_utsw\n22          ri_clinician_utsw_oth\n23               ri_clinician_lbj\n24           ri_clinician_lbj_oth\n25               ri_clinician_utp\n26           ri_clinician_utp_oth\n27                ri_clinician_id\n28              ri_clinician_name\n29                 ri_necessities\n30                 ri_environment\n31       ri_environment_un_reason\n32                   ri_caregiver\n33         ri_caregiver_un_reason\n34               ri_caregiver_oth\n35                     ri_sedated\n36                    ri_isolated\n37                     ri_anxious\n38                  ri_prohibited\n39                 ri_unmet_needs\n40                    ri_injuries\n41              ri_patient_assess\n42                     suspect_em\n43                ri_em_no_reason\n44                   ri_em_reason\n45                   ri_em_type_1\n46                   ri_em_type_2\n47                   ri_em_type_3\n48                   ri_em_type_4\n49                   ri_em_type_5\n50                   ri_em_type_6\n51                   ri_em_type_7\n52                  ri_em_type_98\n53                  ri_em_type_99\n54               ri_em_type_other\n55                      ri_report\n56               ri_aps_no_reason\n57                  ri_refer_svcs\n58          ri_refer_svcs_specify\n59                  ri_reflection\n60            ri_reflection_notes\n61  reporting_instrument_complete\n                                                                                                                                                                                                                                                                                       description\n1                                                                                                                                                                                                                                                                                        Record ID\n2                                                                                                                                                                                                                                                                                Survey Identifier\n3                                                                                                                                                                                                                                                                                 Survey Timestamp\n4                                                                                                                                                                                                                                                                             Form start timestamp\n5                                                                                                                                                                                                                                                                                        Form date\n6                                                                                                                                                                                                                                                                            Enter survey password\n7                                                                                                                                                                                                                                                                            Password verification\n8                                                                                                                                                                                                                               Correct password has not been provided (choice=Password incorrect)\n9                                                                                                                                                                                                                                                                                      Patient MRN\n10                                                                                                                                                                                                                                                                                Institution...10\n11                                                                                                                                                                                                                                                                                Institution...11\n12                                                                                                                                                                                                                  Calculated field for institution based on ri_institution and ri_institution_2.\n13                                                                                                                                                                                                                                                                           Baylor clinician name\n14                                                                                                                                                                                                                                                             Specify other Baylor clinician name\n15                                                                                                                                                                                                                                                                    Johns Hopkins clinician name\n16                                                                                                                                                                                                                                                      Specify other Johns Hopkins clinician name\n17                                                                                                                                                                                                                                                                             UCSF clinician name\n18                                                                                                                                                                                                                                                               Specify other UCSF clinician name\n19                                                                                                                                                                                                                                                                              UAB clinician name\n20                                                                                                                                                                                                                                                                Specify other UAB clinician name\n21                                                                                                                                                                                                                                                                             UTSW clinician name\n22                                                                                                                                                                                                                                                               Specify other UTSW clinician name\n23                                                                                                                                                                                                                                                                              LBJ clinician name\n24                                                                                                                                                                                                                                                                Specify other LBJ clinician name\n25                                                                                                                                                                                                                                                                              UTP clinician name\n26                                                                                                                                                                                                                                                                Specify other UTP clinician name\n27                                                                                                                                                                                                                                                                                    Clinician ID\n28                                                                                                                                                                                                                                                                                  Clinician name\n29                                                                                                                                                                                             Absence of necessities (e.g., inadequate food in cabinets and/or fridge, utilities not functioning)\n30                                                                    Living environment that poses a health or safety concern for the patient or first responders (e.g., fire hazards or obstructed/inaccessible exits, insect or rodent infestation, urine or feces present in the environment.)\n31                                                                                                                                                                                                                                        Specify reason  for inability to assess the environment.\n32                                                                                                                                                         Appear defensive or argumentative, talk over the patient, or resistant to education in a way that negatively impacts the patient's care\n33                                                                                                                                                                                                                                                              Reason caregiver was not assessed.\n34                                                                                                                                                                                                                                         Specify other reason for inability to assess caregiver.\n35                                                                                                                                                                                                                                                                       To be chemically sedated.\n36                                                                                                                                                                                                              To be isolated in the home and/or cut off from needed social networks or supports.\n37                                                                                                                                                 Anxious, emotionally distressed, or depressed because of the quality of care they are receiving and/or their relationship with their caregiver.\n38                                                                                                                                               To be prohibited from freely moving about the home (e.g., confined to one room, no access to walker or wheelchair, inappropriate locks on doors).\n39                                                                                                                              To have unmet needs for assistance with eating, toileting, transferring, dressing, or bathing that are not related to the patient's wishes/refusals of assistance.\n40                                                                                                                                                                                                                                           To have injuries that cannot be adequately explained.\n41                                                                                                                                                                                                                                             Specify reason for inability to assess the patient.\n42                                                                                                                                                                                                                             Do you suspect that the patient is experiencing elder mistreatment?\n43                                                                                                                                                                           Please briefly explain why you don't suspect elder mistreatment given that you observed one or more indicators above.\n44                                                                                                                                                                                                                                      Please briefly explain why you suspect elder mistreatment.\n45                                                              What type(s) of mistreatment do you suspect the patient might be experiencing? Click the link below if you would like to review definitions for the listed elder mistreatment types:Definitions for EM types (choice=Self-neglect)\n46                                                    What type(s) of mistreatment do you suspect the patient might be experiencing? Click the link below if you would like to review definitions for the listed elder mistreatment types:Definitions for EM types (choice=Financial exploitation)\n47                                          What type(s) of mistreatment do you suspect the patient might be experiencing? Click the link below if you would like to review definitions for the listed elder mistreatment types:Definitions for EM types (choice=Emotional or psychological abuse)\n48                                                            What type(s) of mistreatment do you suspect the patient might be experiencing? Click the link below if you would like to review definitions for the listed elder mistreatment types:Definitions for EM types (choice=Physical abuse)\n49                                                              What type(s) of mistreatment do you suspect the patient might be experiencing? Click the link below if you would like to review definitions for the listed elder mistreatment types:Definitions for EM types (choice=Sexual abuse)\n50                                                         What type(s) of mistreatment do you suspect the patient might be experiencing? Click the link below if you would like to review definitions for the listed elder mistreatment types:Definitions for EM types (choice=Caregiver neglect)\n51                                                               What type(s) of mistreatment do you suspect the patient might be experiencing? Click the link below if you would like to review definitions for the listed elder mistreatment types:Definitions for EM types (choice=Abandonment)\n52                                                                     What type(s) of mistreatment do you suspect the patient might be experiencing? Click the link below if you would like to review definitions for the listed elder mistreatment types:Definitions for EM types (choice=Other)\n53                                                       What type(s) of mistreatment do you suspect the patient might be experiencing? Click the link below if you would like to review definitions for the listed elder mistreatment types:Definitions for EM types (choice=Dont know/ Not sure)\n54                                                                                                                                                                                              If you selected 'other' for the mistreatment type, please specify the suspected mistreatment type.\n55                                                                                                                                                                                                                            Do you intend to report your suspicion of elder mistreatment to APS?\n56                                                                                                                                                                                              Please briefly explain why you don't intend to report your suspicion of elder mistreatment to APS.\n57                                                                                                                                                                                                                         Will you refer the patient and/or caregiver to services other than APS?\n58                                                                                                                                                                                                                                                               Please briefly list the services.\n59 Do you have a story or details related to this patient, the screening process, or elder mistreatment in general that you feel may be helpful for this project? This could include specific observations, insights, challenges, or any impactful experiences that came up during this encounter.\n60                                                                                                                   You may choose to:  Write a brief note here (we can follow up with you later for more details) OR Use this space to fully document the story if you prefer to capture it now.\n61                                                                                                                                                                                                                                                                                       Complete?\n                                             label id\n1                                        Record ID  1\n2                                Survey Identifier  2\n3                                 Survey Timestamp  3\n4                             Form start timestamp  4\n5                                        Form date  5\n6                            Enter survey password  6\n7                            Password verification  7\n8                            Password verification  8\n9                                      Patient MRN  9\n10                                     Institution 10\n11                                     Institution 11\n12                                     Institution 12\n13                           Baylor clinician name 13\n14                     Other Baylor clinician name 14\n15                    Johns Hopkins clinician name 15\n16              Other Johns Hopkins clinician name 16\n17                             UCSF clinician name 17\n18                       Other UCSF clinician name 18\n19                              UAB clinician name 19\n20                        Other UAB clinician name 20\n21                             UTSW clinician name 21\n22                       Other UTSW clinician name 22\n23                              LBJ clinician name 23\n24                        Other LBJ clinician name 24\n25                              UTP clinician name 25\n26                        Other UTP clinician name 26\n27                                    Clinician ID 27\n28                                  Clinician name 28\n29                          Absence of necessities 29\n30            Environment health or safety concern 30\n31                 Environment not assessed reason 31\n32                                       Defensive 32\n33                   Caregiver not assessed reason 33\n34             Other reason caregiver not assessed 34\n35                              Chemically sedated 35\n36                                        Isolated 36\n37                                         Anxious 37\n38                                      Prohibited 38\n39                                     Unmet needs 39\n40                            Unexplained injuries 40\n41                     Patient not assessed reason 41\n42                                      Suspect EM 42\n43 Indicators observed but EM not suspected reason 43\n44                               Suspect EM reason 44\n45                          Self-neglect suspected 45\n46                Financial exploitation suspected 46\n47      Emotional or psychological abuse suspected 47\n48                        Physical abuse suspected 48\n49                          Sexual abuse suspected 49\n50                     Caregiver neglect suspected 50\n51                           Abandonment suspected 51\n52               Other mistreatment type suspected 52\n53        Dont know/ Not sure of mistreatment type 53\n54      Specific other mistreatment type suspected 54\n55                         Intend to report to APS 55\n56            No intention to report to APS reason 56\n57                          Other service referral 57\n58                           Specify other service 58\n59                            Have helpful details 59\n60                                      Brief note 60\n61                                        Complete 61\n```\n\n\n:::\n:::\n\n\n\n# Replace labels with variable names in the label data frame\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create a named vector with variable names and variable descriptions \nnaming_vec <- setNames(as.list(var_desc$description),\n                               var_desc$variable)\n\n# Rename the variables using the vector\ntool_pilot <- tool_pilot_labels %>% rename(unlist(naming_vec))\n```\n:::\n\n\n\n# Create new variables\n\n## Replace reporting instument timestamp variable with timestamp end variable\n\nThe `reporting_instrument_timestamp` variable contains information on both the submission time and the completion status of each survey response. The variable `reporting_instrument_complete` also provides completion status information. A new variable will be created that only contains the sumbmission time and the reporting_instrument_timestamp variable will be removed.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntool_pilot <- tool_pilot %>% \n  mutate(\n    timestamp_end = case_when(\n      is.na(reporting_instrument_timestamp) ~ NA,\n      reporting_instrument_timestamp == \"[not completed]\" ~ NA,\n      TRUE ~ reporting_instrument_timestamp\n    ),\n    timestamp_end = as.POSIXct(timestamp_end, tz = \"UTC\")\n  ) %>% relocate(c(timestamp_end, reporting_instrument_complete),\n                 .after = ri_timestamp_start) %>%\n  select(-c(reporting_instrument_timestamp))\n```\n:::\n\n\n## Clinician names\n\nCombine clinician names across all institutions into a single column\n\n\n::: {.cell}\n\n```{.r .cell-code}\nclinician_names <- c(\"ri_clinician_bcm\", \"ri_clinician_bcm_oth\", \n                     \"ri_clinician_jh\", \"ri_clinician_jh_oth\", \n                     \"ri_clinician_ucsf\", \"ri_clinician_ucsf_oth\", \n                     \"ri_clinician_uab\", \"ri_clinician_uab_oth\", \n                     \"ri_clinician_utsw\", \"ri_clinician_utsw_oth\", \n                     \"ri_clinician_lbj\", \"ri_clinician_lbj_oth\", \n                     \"ri_clinician_utp\", \"ri_clinician_utp_oth\")\n\ntool_pilot <- tool_pilot %>% \n  mutate(\n    ri_clinician_id_name = coalesce(ri_clinician_utp_oth, ri_clinician_utp, \n                                     ri_clinician_lbj_oth, ri_clinician_lbj, \n                                     ri_clinician_utsw_oth, ri_clinician_utsw, \n                                     ri_clinician_uab_oth, ri_clinician_uab, \n                                     ri_clinician_ucsf_oth, ri_clinician_ucsf, \n                                     ri_clinician_jh_oth, ri_clinician_jh, \n                                     ri_clinician_bcm_oth, ri_clinician_bcm)\n    ) %>% select(-c(all_of(clinician_names))) %>%\n  relocate(ri_clinician_id_name, .after = ri_clinician_id)\n```\n:::\n\n\n## Numeric and factor variables\n\n### Institution\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncols <- c(\"ri_institution\", \"ri_institution_2\")\nget_values(tool_pilot, cols)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Baylor College of Medicine - BT House Calls\"\n[2] \"Johns Hopkins - JHOME\"                      \n[3] \"University of Alabama - UAB House Calls\"    \n[4] \"UT Southwestern - COVE\"                     \n[5] \"UTH Houston - LBJ House Calls\"              \n[6] \"UTH Houston - UT Physicians House Calls\"    \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Baylor College of Medicine - BT House Calls\" = 1, \n    \"Johns Hopkins - JHOME\" = 2, \n    \"UCSF - Care at Home Program\" = 3,\n    \"University of Alabama - UAB House Calls\" = 4, \n    \"UT Southwestern - COVE\" = 5, \n    \"UTH Houston - LBJ House Calls\" = 6,\n    \"UTH Houston - UT Physicians House Calls\" = 7\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"7cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\ntool_pilot <- tool_pilot %>%\n  rename(calc_institution_7cat = calc_institution) %>%\n  mutate(\n    calc_institution_7cat_f = factor(\n      calc_institution_7cat, levels = as.numeric(value_labels),\n      labels = names(value_labels)\n    )\n  ) %>% relocate(calc_institution_7cat_f, .after = calc_institution_7cat)\n```\n:::\n\n\n### Screening items\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncols <- c(\"ri_necessities\", \"ri_environment\", \"ri_caregiver\", \"ri_sedated\", \n          \"ri_isolated\", \"ri_anxious\", \"ri_prohibited\", \"ri_unmet_needs\", \n          \"ri_injuries\")\n\nget_values(tool_pilot, cols)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"No\"               \"Unable to assess\" \"Yes\"             \n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Yes\" = 1,\n    \"No\" = 0,\n    \"Unable to assess\" = 99\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"3cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n:::\n\n\n### ri_caregiver_un_reason\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncols <- c(\"ri_caregiver_un_reason\")\n\nget_values(tool_pilot, cols)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"Caregiver not present\"\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Caregiver not present\" = 1,\n    \"Other reason\" = 98\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"2cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n:::\n\n\n### Yes or No\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncols <- c(\"suspect_em\", \"ri_report\", \"ri_refer_svcs\", \"ri_reflection\")\n\nget_values(tool_pilot, cols)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"No\"  \"Yes\"\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Yes\" = 1,\n    \"No\" = 0\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"2cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n:::\n\n\n### EM type\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncols <- paste0(\"ri_em_type_\", c(1:7, 98, 99))\n\n### Change factor labels from \"checked\" and \"unchecked\" to \"Yes\" and \"No\"\ntool_pilot <- tool_pilot %>% \n  mutate(\n    across(\n      .cols = all_of(cols),\n      .fns = ~ case_when(\n        .x == \"Checked\" ~ \"Yes\",\n        .x == \"Unchecked\" ~ \"No\"\n      )\n    )\n  )\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nget_values(tool_pilot, cols)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] \"No\"  \"Yes\"\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\n# Numeric coding for character values in each column of interest\nvalue_labels <- c(\n    \"Yes\" = 1,\n    \"No\" = 0\n)\n\n# NA values\nna_values <- c()\n\n# Suffix for the version of each column with \"Don't Know\" and \"Refused\" changed\n# to NA.\nsuffix <- \"2cat\"\n\n# Labels and levels for factors (Shouldn't need to change this code)\nfactor_labs_levs <- value_labels[!value_labels %in% na_values]\n\n# Column names for the version of each column with \"Don't Know\" and \"Refused\" \n# changed to NA (Shouldn't need to change this code).\ncols_suffix <- paste(cols, suffix, sep = \"_\")\n\n# Prepare columns for analysis\n# - Convert character values to numeric values\n# - Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n# - Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n# - Arrange the columns as: original column, numeric column w/o \"Don't know\" and \n#   \"Refused\", and the factor version of the column.\ntool_pilot <- tool_pilot |>\n  # Convert character values to numeric values\n  chars_to_nums(cols, value_labels) |> \n  # Create a version of each column with \"Don't know\" and \"Refused\" converted to NA\n  nums_to_nas(cols, na_values, suffix) |> \n  # Relocate new columns with NA values immediately after the original column\n  relocate_na_cols(cols, suffix) |> \n  # Create a factor version of each column (w/o \"Don't know\" and \"Refused\")\n  factors(cols_suffix, factor_labs_levs) |> \n  # Relocate factor columns immediately after the new columns with NA values\n  relocate_factors(cols_suffix) |>\n  # Drop the original variable if the version with \"cat\" suffix has the exact\n  # same values.\n  drop_dup_orig(cols, cols_suffix)\n```\n:::\n\n\n\n# Remove variables without important research data\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntool_pilot <- tool_pilot %>% \n  select(-c(redcap_survey_identifier, password_entry, password_incorrect_1, \n            ri_clinician_name))\n```\n:::\n\n\n\n# Filter only data for dates relevant to the pilot\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Create sequence of relevant dates\ndates <- c(seq(as.Date('2024-11-11'), as.Date('2024-11-25'), by = \"day\"))\n\n# Filter the ri_date variable to include only dates in\n# sequence\ntool_pilot <- tool_pilot %>% filter(as.Date(ri_date) %in% dates)\n```\n:::\n\n\n\n# Update variable descriptions dataframe with new variables\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntool_pilot_vars <- names(tool_pilot) %>% \n  # Subset new variables\n  setdiff(., var_desc$variable) %>%\n  list() %>%\n  # Convert list of new variables into dataframe\n  as.data.frame(col.names = \"variable\") %>%\n  # Join descriptions from var_desc dataframe to new data frame \n  mutate(\n    no_suffix = gsub(\"_[0-9]+cat[_f]*\", \"\", x = variable)\n  ) %>% inner_join(var_desc, by = c(\"no_suffix\" = \"variable\")) %>%\n  # remove \"no_suffix\" variable\n  select(-c(no_suffix))\n\nvar_desc <- bind_rows(var_desc, tool_pilot_vars) %>% \n  add_row(variable = \"timestamp_end\", description = \"Form end timestamp\",\n          label = \"Form start timestamp\", id = 62) %>% arrange(id) %>% \n  add_row(variable = \"ri_clinician_id_name\", description = \"Clinician name\",\n          label = \"Clinician name\", id = 28) %>% arrange(id) %>%\n  select(-c(id))\n```\n:::\n\n\n\n# Merge link data and convert to long format\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Merge all the link data into one dataframe\nlink_hits <- list(definitions_link_hits, al_link_hits, ca_link_hits, \n                  md_link_hits, tx_link_hits) %>% purrr::reduce(left_join, \n                                                                by = \"date\") %>%\n  # Convert data frame to long form\n  tidyr::pivot_longer(!date, names_to = \"link\", values_to = \"hits\") %>%\n  mutate(\n    date = lubridate::mdy(date)\n  )\n```\n:::\n\n\n\n# Save data\n\n\n::: {.cell}\n\n```{.r .cell-code}\nwrite_rds(tool_pilot, here::here(\"data\", \"detect_tool_pilot\",\n                                 \"detect_tool_pilot_cleaned.RDS\"))\n\nwrite_rds(var_desc, here::here(\"data_management\", \"detect_tool_pilot\", \n                               \"variable_descriptions.RDS\"))\n\nwrite_rds(link_hits, here::here(\"data\", \"detect_tool_pilot\",\n                               \"detect_tool_pilot_link_hits_long_format.RDS\"))\n```\n:::\n",
    "supporting": [
      "data_01_detect_tool_pilot_test_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}